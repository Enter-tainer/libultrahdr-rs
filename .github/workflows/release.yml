name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  checks:
    name: Format, Clippy, Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            nasm \
            pkg-config \
            libegl1-mesa-dev \
            libgles2-mesa-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --workspace --all-targets --all-features --locked -- -D warnings

      - name: Tests
        run: cargo test --workspace --all-features --locked

  build-binaries:
    name: Build release binaries (${{ matrix.target }})
    needs: checks
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            os: linux
          - runner: macos-14
            target: aarch64-apple-darwin
            os: macos
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            os: windows

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            nasm \
            pkg-config

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja nasm pkg-config

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install nasm cmake ninja -y

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2

      - name: Build ultrahdr-bake (release)
        run: cargo build -p ultrahdr-bake --release --locked --target ${{ matrix.target }}

      - name: Prepare artifact
        shell: bash
        run: |
          set -eo pipefail
          ARTIFACT_DIR="artifacts"
          mkdir -p "$ARTIFACT_DIR"
          case "${{ matrix.os }}" in
            windows)
              BIN="target/${{ matrix.target }}/release/ultrahdr-bake.exe"
              OUT="ultrahdr-bake-${{ matrix.target }}.exe"
              ;;
            *)
              BIN="target/${{ matrix.target }}/release/ultrahdr-bake"
              OUT="ultrahdr-bake-${{ matrix.target }}"
              ;;
          esac
          cp "$BIN" "$ARTIFACT_DIR/$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ultrahdr-bake-${{ matrix.target }}
          path: artifacts/ultrahdr-bake-${{ matrix.target }}*

  publish-crates-io:
    name: Publish to crates.io
    needs: checks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2

      - name: Authenticate with crates.io (OIDC)
        id: auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          set -eo pipefail
          cargo publish -p ultrahdr-sys --locked
          # Give the index a moment to pick up ultrahdr-sys before publishing dependents.
          sleep 5
          cargo publish -p ultrahdr --locked
          # Publish CLI after library crates land.
          sleep 5
          cargo publish -p ultrahdr-bake --locked

  build-wasm:
    name: Build wasm (wasm32-wasip1)
    needs: checks
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Build wasm binary
        uses: ./.github/actions/build-wasm

      - name: Prepare wasm artifact
        run: |
          set -eo pipefail
          ARTIFACT_DIR="artifacts"
          mkdir -p "$ARTIFACT_DIR"
          cp target/wasm32-wasip1/release/ultrahdr-bake.wasm "$ARTIFACT_DIR/ultrahdr-bake-wasm32-wasip1.wasm"

      - name: Upload wasm artifact
        uses: actions/upload-artifact@v4
        with:
          name: ultrahdr-bake-wasm32-wasip1
          path: artifacts/ultrahdr-bake-wasm32-wasip1.wasm

  release:
    name: Create GitHub release
    needs:
      - build-binaries
      - build-wasm
      - publish-crates-io
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: ultrahdr-bake-*
          merge-multiple: true

      - name: Create release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
